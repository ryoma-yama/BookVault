# 蔵書管理アプリ 要件定義書（小規模 / Cloudflare Pages構成）

## 1. 開発・運用方針
- フレームワーク：Remix（Cloudflare Pages対応）
- インフラ：Cloudflare Pages + D1（DB） + KV（必要に応じて）
- コスト方針：無料枠内での運用を前提
- データ規模：蔵書数・ユーザー数ともに三桁未満。大規模なスケーラビリティは現時点で想定せず

## 2. 機能一覧

### 2.1 基本機能
#### 蔵書管理（CRUD）
- タイトル、著者、ISBN、出版社、出版年などの情報を管理
- 複数著者に対応（正規化済み）
- 管理画面は認証済みユーザーのみ利用可能

#### ユーザー登録・ログイン
- 利用者識別のためアカウント登録が必要
- 管理者／一般ユーザーの区別は現時点では行わない
- 認証方式は Cloudflare Access を使用予定
  - Google, GitHub, AzureAD 等のIdPに対応（設定は後述）

#### ユーザー登録・ログイン
- 利用者識別のためアカウント登録が必要
- 管理者／一般ユーザーの区別は現時点では行わない
- 認証方式は Cloudflare Access を使用予定
  - Google, GitHub, AzureAD 等のIdPに対応（設定は後述）
- アプリ側でのユーザー認証に使うメールアドレスは、必ず `~/lib/auth.ts` の `getAuthenticatedEmail(request, env)` 関数を使用すること。この関数は JWT（`cf-access-jwt-assertion`）ヘッダからメールを抽出し、ローカル開発時は環境変数 `DEV_AUTH_EMAIL` から代用的に取得する。JWTが正しく解析できない場合や email フィールドが置かれていない場合はエラーを発生させ、不正リクエストを停止する。

### 2.2 追加機能
#### プロフィール管理
- 表示名の変更（最低限）
- 将来的に好みのタグ設定などに拡張可能

#### 貸出・返却管理
- 蔵書単位での貸出／返却履歴を記録
- ワンクリック返却機能
- ログインユーザーと紐づけて貸出記録を保持

#### タグ管理
- タグの追加／削除（蔵書登録時にも可）
- タグでのフィルター検索が可能

#### 検索機能
- タイトル、著者、出版社、タグによる検索
- 全文検索は現時点では非対応
- 適切なインデックス設計によりLIKE検索で対応

#### 外部API連携
- Google Books API を用いた書籍情報の自動取得（画像URL含む）
- ブラウザカメラ + ISBN読み取りによる登録支援

#### レビュー・評価（任意実装）
- 書籍ごとにユーザーがレビュー／評価を投稿
- 書籍モデルに対し別テーブルで管理予定

#### 貸出履歴の保持
- 全ユーザーの履歴を保持（時系列）
- 延滞や人気本確認に利用可能

#### 貸出制限
- 同時貸出冊数制限や人気書籍の制限に対応（予定）
- ログイン状態が前提

#### 予約機能
- 現在貸出中の本を返却後に予約可能
- 別テーブルまたはフラグで管理

#### おすすめ蔵書表示
- 人気本やジャンル別にリスト表示

#### 通知機能（構想のみ）
- 返却期限のリマインド通知（メールなど）
- Cloudflare Workers + Cron または GitHub Actions でバッチ処理予定
- 現時点では実装優先度が低いため保留

#### 管理ダッシュボード
- 貸出状況、人気本、延滞状況などの可視化

## 3. 非機能要件・方針

### 3.1 状態管理
- React本来の仕組みで完結（Contextなどは不要）
- useFetcher等を活用しRemix流で実装

### 3.2 セッション管理
- Cloudflare Accessによるヘッダベースの認証（cf-access-jwt-assertion）
- ログインユーザー情報はサーバー側で検証しアプリ側で認識

### 3.3 アップロード・ストレージ
- 表紙画像はGoogle Books APIが提供するURLをそのまま利用
- ファイルアップロードは実装しない

### 3.4 ログ・監査
- Cloudflare Access経由のアクセス履歴はZero Trust ダッシュボードで確認可能（保持期間あり）
- 蔵書貸出／返却などの操作ログはアプリ側でDBに保存を検討

### 3.5 拡張性・保守性
- 現時点での最小構成を優先し、拡張は必要になった段階で判断
- ORMはDrizzleなど軽量かつ型安全なものを使用
- フロントはTailwindCSSなどで簡潔に整える

## 4. 今後の検討課題（低優先）
- 通知機能（メール、Slack連携）
- 操作ログ／監査テーブルの設計
- より細かな認可（管理者・一般ユーザー分離）
- 多言語対応（日本語以外への拡張）

## 5. 使用予定技術（暫定）
- Remix（Pages向け）
- Cloudflare Pages, D1, Access
- Google Books API
- Tailwind CSS
- Drizzle ORM
- その他必要に応じて

